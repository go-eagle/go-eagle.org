"use strict";(self.webpackChunkgo_eagle_org_2=self.webpackChunkgo_eagle_org_2||[]).push([[2269],{3905:function(e,n,t){t.d(n,{Zo:function(){return u},kt:function(){return m}});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var o=a.createContext({}),p=function(e){var n=a.useContext(o),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},u=function(e){var n=p(e.components);return a.createElement(o.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},k=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,l=e.originalType,o=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),k=p(t),m=r,d=k["".concat(o,".").concat(m)]||k[m]||c[m]||l;return t?a.createElement(d,s(s({ref:n},u),{},{components:t})):a.createElement(d,s({ref:n},u))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var l=t.length,s=new Array(l);s[0]=k;var i={};for(var o in n)hasOwnProperty.call(n,o)&&(i[o]=n[o]);i.originalType=e,i.mdxType="string"==typeof e?e:r,s[1]=i;for(var p=2;p<l;p++)s[p]=t[p];return a.createElement.apply(null,s)}return a.createElement.apply(null,t)}k.displayName="MDXCreateElement"},5683:function(e,n,t){t.r(n),t.d(n,{contentTitle:function(){return o},default:function(){return k},frontMatter:function(){return i},metadata:function(){return p},toc:function(){return u}});var a=t(7462),r=t(3366),l=(t(7294),t(3905)),s=["components"],i={id:"aws-eks-deploy",title:"\u90e8\u7f72\u5e94\u7528\u5230aws eks\u96c6\u7fa4",description:"\u90e8\u7f72\u5230aws\u7684eks\u96c6\u7fa4",keywords:["Go","Eagle","Toolkit","Framework","Microservices","HTTP"],slug:"/deployment/aws-eks-deploy"},o=void 0,p={unversionedId:"deployment/aws-eks-deploy",id:"deployment/aws-eks-deploy",isDocsHomePage:!1,title:"\u90e8\u7f72\u5e94\u7528\u5230aws eks\u96c6\u7fa4",description:"\u90e8\u7f72\u5230aws\u7684eks\u96c6\u7fa4",source:"@site/docs/deployment/aws-eks-deploy.md",sourceDirName:"deployment",slug:"/deployment/aws-eks-deploy",permalink:"/docs/deployment/aws-eks-deploy",editUrl:"https://github.com/go-eagle/go-eagle.org/edit/main/docs/deployment/aws-eks-deploy.md",version:"current",frontMatter:{id:"aws-eks-deploy",title:"\u90e8\u7f72\u5e94\u7528\u5230aws eks\u96c6\u7fa4",description:"\u90e8\u7f72\u5230aws\u7684eks\u96c6\u7fa4",keywords:["Go","Eagle","Toolkit","Framework","Microservices","HTTP"],slug:"/deployment/aws-eks-deploy"},sidebar:"docs",previous:{title:"\u5e94\u7528\u90e8\u7f72",permalink:"/docs/deployment/app-deploy"},next:{title:"\u5f00\u53d1\u89c4\u8303 - Protobuf",permalink:"/docs/guide/api-protobuf"}},u=[{value:"\u521b\u5efaEKS\u96c6\u7fa4",id:"\u521b\u5efaeks\u96c6\u7fa4",children:[{value:"\u914d\u7f6e\u96c6\u7fa4\u57fa\u672c\u4fe1\u606f",id:"\u914d\u7f6e\u96c6\u7fa4\u57fa\u672c\u4fe1\u606f",children:[]},{value:"\u6dfb\u52a0 node group",id:"\u6dfb\u52a0-node-group",children:[]}]},{value:"\u672c\u5730\u64cd\u4f5ceks",id:"\u672c\u5730\u64cd\u4f5ceks",children:[{value:"\u7ed9\u7528\u6237\u6dfb\u52a0\u7b56\u7565",id:"\u7ed9\u7528\u6237\u6dfb\u52a0\u7b56\u7565",children:[]},{value:"\u66f4\u65b0\u914d\u7f6e\u5230\u672c\u5730",id:"\u66f4\u65b0\u914d\u7f6e\u5230\u672c\u5730",children:[]},{value:"\u5207\u6362\u5230\u6307\u5b9a\u96c6\u7fa4",id:"\u5207\u6362\u5230\u6307\u5b9a\u96c6\u7fa4",children:[]},{value:"\u67e5\u770b\u96c6\u7fa4\u4fe1\u606f",id:"\u67e5\u770b\u96c6\u7fa4\u4fe1\u606f",children:[]}]},{value:"\u6dfb\u52a0\u673a\u5668",id:"\u6dfb\u52a0\u673a\u5668",children:[{value:"\u6dfb\u52a0node",id:"\u6dfb\u52a0node",children:[]},{value:"\u914d\u7f6enode",id:"\u914d\u7f6enode",children:[]}]},{value:"\u90e8\u7f72\u5e94\u7528\u5230EKS",id:"\u90e8\u7f72\u5e94\u7528\u5230eks",children:[{value:"\u521b\u5efaaws\u8ba4\u8bc1",id:"\u521b\u5efaaws\u8ba4\u8bc1",children:[]},{value:"\u90e8\u7f72deploy\u548cservice",id:"\u90e8\u7f72deploy\u548cservice",children:[]},{value:"\u7533\u8bf7\u57df\u540d",id:"\u7533\u8bf7\u57df\u540d",children:[]},{value:"\u90e8\u7f72ingress",id:"\u90e8\u7f72ingress",children:[]},{value:"\u5b89\u88c5 ingress controller",id:"\u5b89\u88c5-ingress-controller",children:[]},{value:"\u914d\u7f6eTLS\u8bc1\u4e66",id:"\u914d\u7f6etls\u8bc1\u4e66",children:[]},{value:"\u4f7f\u7528Github Actions \u81ea\u52a8\u90e8\u7f72\u5230EKS",id:"\u4f7f\u7528github-actions-\u81ea\u52a8\u90e8\u7f72\u5230eks",children:[]}]},{value:"k9s\u4f7f\u7528",id:"k9s\u4f7f\u7528",children:[{value:"\u5b89\u88c5 k9s",id:"\u5b89\u88c5-k9s",children:[]},{value:"k9s\u7684\u4f7f\u7528",id:"k9s\u7684\u4f7f\u7528",children:[]}]},{value:"Reference",id:"reference",children:[]}],c={toc:u};function k(e){var n=e.components,t=(0,r.Z)(e,s);return(0,l.kt)("wrapper",(0,a.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("h2",{id:"\u521b\u5efaeks\u96c6\u7fa4"},"\u521b\u5efaEKS\u96c6\u7fa4"),(0,l.kt)("h3",{id:"\u914d\u7f6e\u96c6\u7fa4\u57fa\u672c\u4fe1\u606f"},"\u914d\u7f6e\u96c6\u7fa4\u57fa\u672c\u4fe1\u606f"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u540d\u79f0"),(0,l.kt)("li",{parentName:"ul"},"\u9009\u62e9\u7248\u672c\u53f7"),(0,l.kt)("li",{parentName:"ul"},"\u96c6\u7fa4\u670d\u52a1\u89d2\u8272(\u521b\u5efa\u5b8c\u89d2\u8272\u540e\uff0c\u56de\u6765\u5237\u65b0\u5373\u53ef\u770b\u5230\uff1aAWSEKSClusterRole)")),(0,l.kt)("h4",{id:"\u521b\u5efa\u96c6\u7fa4\u670d\u52a1\u89d2\u8272"},"\u521b\u5efa\u96c6\u7fa4\u670d\u52a1\u89d2\u8272"),(0,l.kt)("p",null,"\u5177\u4f53\u6b65\u9aa4\uff1a"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"1\u3001\u9009\u62e9\u7c7b\u578b\uff1a AWS service"),(0,l.kt)("li",{parentName:"ul"},"2\u3001\u9009\u62e9 use case: EKS"),(0,l.kt)("li",{parentName:"ul"},"3\u3001\u9009\u62e9\u4f60\u7684 use case: EKS - Cluster"),(0,l.kt)("li",{parentName:"ul"},"4\u3001\u6dfb\u52a0policy\uff1aAmazonEKSClusterPolicy"),(0,l.kt)("li",{parentName:"ul"},"5\u3001\u6dfb\u52a0tags\uff0c \u53ef\u9009"),(0,l.kt)("li",{parentName:"ul"},"6\u3001\u9884\u89c8\uff0c\u8f93\u5165\u89d2\u8272\u540d: AWSEKSClusterRole, \u4ee5\u53ca\u63cf\u8ff0")),(0,l.kt)("h4",{id:"\u7f51\u7edc\u914d\u7f6e"},"\u7f51\u7edc\u914d\u7f6e"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u7f51\u7edc\uff1a\u9009\u62e9\u9ed8\u8ba4\u7684vpc\uff0c\u5176\u4ed6\u4e0d\u7528\u914d\u7f6e\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u5b89\u5168\u7ec4\uff1a\u9ed8\u8ba4\u4e0d\u7528\u6307\u5b9a"),(0,l.kt)("li",{parentName:"ul"},"\u96c6\u7fa4endpoint\u8bbf\u95ee\uff1aPublic and private"),(0,l.kt)("li",{parentName:"ul"},"VPC-CNI: \u9009\u6700\u65b0\u7248"),(0,l.kt)("li",{parentName:"ul"},"CoreDNS: \u9009\u6700\u65b0"),(0,l.kt)("li",{parentName:"ul"},"kube-proxy: \u9009\u6700\u65b0")),(0,l.kt)("h4",{id:"\u65e5\u5fd7\u914d\u7f6e"},"\u65e5\u5fd7\u914d\u7f6e"),(0,l.kt)("p",null,"\u9ed8\u8ba4\u90fd\u7981\u7528\u5373\u53ef\uff0c\u4e5f\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u8981\u5f00\u542f\u5bf9\u5e94\u7684\u9009\u9879\u3002"),(0,l.kt)("h3",{id:"\u6dfb\u52a0-node-group"},"\u6dfb\u52a0 node group"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u586b\u5199group\u540d\u79f0"),(0,l.kt)("li",{parentName:"ul"},"\u586b\u5199Node IAM Role(\u521b\u5efa\u5b8c\u89d2\u8272\u540e\uff0c\u56de\u6765\u5237\u65b0\u5373\u53ef\u770b\u5230\uff1aAWSEKSNodeRole)")),(0,l.kt)("h4",{id:"\u521b\u5efanode-iam\u89d2\u8272"},"\u521b\u5efaNode IAM\u89d2\u8272"),(0,l.kt)("p",null,"\u5177\u4f53\u6b65\u9aa4\uff1a"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"1\u3001\u9009\u62e9\u7c7b\u578b\uff1a AWS service"),(0,l.kt)("li",{parentName:"ul"},"2\u3001\u9009\u62e9 use case: EC2"),(0,l.kt)("li",{parentName:"ul"},"3\u3001\u6dfb\u52a0policy\uff1aAmazonEKS_CNI_Policy\u3001AmazonEKSWorkerNodePolicy\u3001AmazonEC2ContainerRegistryReadOnly"),(0,l.kt)("li",{parentName:"ul"},"4\u3001\u6dfb\u52a0tags\uff0c \u53ef\u9009"),(0,l.kt)("li",{parentName:"ul"},"5\u3001\u9884\u89c8\uff0c\u8f93\u5165\u89d2\u8272\u540d: AWSEKSNodeRole, \u4ee5\u53ca\u63cf\u8ff0")),(0,l.kt)("h4",{id:"\u914d\u7f6e\u673a\u5668\u53ca\u6269\u5bb9\u4fe1\u606f"},"\u914d\u7f6e\u673a\u5668\u53ca\u6269\u5bb9\u4fe1\u606f"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u9009\u62e9 AMI \u7c7b\u578b\uff1a\u9ed8\u8ba4\u9009\u62e9\u7b2c\u4e00\u4e2a"),(0,l.kt)("li",{parentName:"ul"},"\u9009\u62e9\u5bb9\u91cf\u7c7b\u578b\uff1a\u6309\u9700\u8fd8\u662fspot"),(0,l.kt)("li",{parentName:"ul"},"\u9009\u62e9\u5b9e\u4f8b\u7c7b\u578b\uff1at3.small"),(0,l.kt)("li",{parentName:"ul"},"\u78c1\u76d8\u5bb9\u91cf\uff1a10G\uff08\u9ed8\u8ba4\u4e3a20G\uff09"),(0,l.kt)("li",{parentName:"ul"},"\u6269\u5bb9\u914d\u7f6e\uff1amin node: 1, max node: 2, desired node: 1"),(0,l.kt)("li",{parentName:"ul"},"\u6700\u5927\u4e0d\u53ef\u8fbe\uff1a\u9009\u62e9\u6309\u6570\u91cf\uff0c\u4e5f\u6709\u6309\u767e\u5206\u6bd4\u7684\uff0c\u6570\u91cf\u9009\u4e3a1")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u6ce8\u610f\uff1a\u4e0d\u901a\u7684node\u7c7b\u578b\u652f\u6301\u7684pod\u6570\u91cf\u4e0d\u901a\uff0c\u5982\u679c\u662f\u9009\u62e9t3.micro\u673a\u5668\uff0c\u9ed8\u8ba4\u662f4\u4e2a\uff0c\u7cfb\u7edf\u76f8\u5173pod\u5df2\u7ecf\u5360\u7528\u4e864\u4e2a\uff0c\u6240\u4ee5\u5e94\u7528\u7684pod\u4f1a\u65e0\u6cd5\u542f\u52a8\u3002\n\u53ef\u4ee5\u4f7f\u7528k9s\u5728\u914d\u7f6e\u91cc\u8fdb\u884c\u67e5\u770b\u3002\n\u5177\u4f53\u53ef\u4ee5\u67e5\u770b\u6b64\u94fe\u63a5\uff1a",(0,l.kt)("a",{parentName:"p",href:"https://github.com/awslabs/amazon-eks-ami/blob/master/files/eni-max-pods.txt"},"https://github.com/awslabs/amazon-eks-ami/blob/master/files/eni-max-pods.txt"))),(0,l.kt)("h4",{id:"\u6307\u5b9a\u7f51\u7edc"},"\u6307\u5b9a\u7f51\u7edc"),(0,l.kt)("p",null,"\u5173\u95ed\u8fdc\u7a0b\u8bbf\u95ee\uff0c\u5176\u4ed6\u9ed8\u8ba4\u3002"),(0,l.kt)("h2",{id:"\u672c\u5730\u64cd\u4f5ceks"},"\u672c\u5730\u64cd\u4f5ceks"),(0,l.kt)("h3",{id:"\u7ed9\u7528\u6237\u6dfb\u52a0\u7b56\u7565"},"\u7ed9\u7528\u6237\u6dfb\u52a0\u7b56\u7565"),(0,l.kt)("p",null,"IAM -> user -> usergroup -> deployment(\u4e4b\u524d\u81ea\u5df1\u5b9a\u4e49\u7684\u540d\u79f0) -> \u6dfb\u52a0policy:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Service: EKS"),(0,l.kt)("li",{parentName:"ul"},"Actions: All EKS Actions"),(0,l.kt)("li",{parentName:"ul"},"Resources: All resources"),(0,l.kt)("li",{parentName:"ul"},"Name: EKSFullAccess")),(0,l.kt)("h3",{id:"\u66f4\u65b0\u914d\u7f6e\u5230\u672c\u5730"},"\u66f4\u65b0\u914d\u7f6e\u5230\u672c\u5730"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"aws eks update-kubeconfig --name microservice --region ap-southeast-1\n# Output\nAdded new context arn:aws:eks:ap-southeast-1:xxxxxxxx:cluster/microservice to ~/.kube/config\n")),(0,l.kt)("h3",{id:"\u5207\u6362\u5230\u6307\u5b9a\u96c6\u7fa4"},"\u5207\u6362\u5230\u6307\u5b9a\u96c6\u7fa4"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl config use-context arn:aws:eks:ap-southeast-1:xxxxxxxx:cluster/microservice\n")),(0,l.kt)("h3",{id:"\u67e5\u770b\u96c6\u7fa4\u4fe1\u606f"},"\u67e5\u770b\u96c6\u7fa4\u4fe1\u606f"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl cluster-info\n\n# Output\nKubernetes control plane is running at https://D5420D4721F9178A5090C1DDFD451415.gr7.ap-southeast-1.eks.amazonaws.com\nCoreDNS is running at https://D5420D78A5090C451415.gr7.ap-southeast-1.eks.amazonaws.com/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy\n\nTo further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.\n")),(0,l.kt)("p",null,"\u6b64\u65f6\u5982\u679c\u62a5\u9519\uff1a",(0,l.kt)("inlineCode",{parentName:"p"},"error: You must be logged to the server (Unauthorized)"),(0,l.kt)("br",{parentName:"p"}),"\n","\u67e5\u770b\u914d\u7f6e\uff1a",(0,l.kt)("inlineCode",{parentName:"p"},"aws sts get-caller-identity")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'{\n  "UserId": "xxxxxx",\n  "Account": "yyyyyy",\n  "Arn": "arn:aws:iam:yyyyyy:user/github-ci"\n}\n')),(0,l.kt)("p",null,"\u539f\u56e0\u662f\uff1a\u4e0d\u662f\u96c6\u7fa4\u7684root\u7528\u6237\u6216\u8005owner\u7528\u6237\uff0c\u6240\u4ee5\u65e0\u6cd5\u64cd\u4f5c\u3002\n\u89e3\u51b3\u65b9\u6cd5\uff1a\u914d\u7f6e ",(0,l.kt)("inlineCode",{parentName:"p"},"KeyID")," \u548c ",(0,l.kt)("inlineCode",{parentName:"p"},"SecretKey")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u67e5\u770b\u73b0\u6709\u7684key: ",(0,l.kt)("inlineCode",{parentName:"li"},"cat ~/.aws/config"))),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# Output\n[default]\naws_access_key_id = xxxxxx\naws_secret_access_key = yyyyyyyyy\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5728\u6839\u7528\u6237\u4e0b\u65b0\u5efakey")),(0,l.kt)("p",null,"\u67e5\u770b\u6839\u7528\u6237\u7684 security_credentials: ",(0,l.kt)("a",{parentName:"p",href:"https://ap-southeast-1.console.aws.amazon.com/iam/home?region=us-west-1#security_credential"},"https://ap-southeast-1.console.aws.amazon.com/iam/home?region=us-west-1#security_credential"),"\n\u5728 ",(0,l.kt)("inlineCode",{parentName:"p"},"Access keys")," Section \u91cc\u65b0\u5efakey"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u6dfb\u52a0\u5230 ",(0,l.kt)("inlineCode",{parentName:"li"},"~/.aws/config"))),(0,l.kt)("p",null,"\u6dfb\u52a0\u540e\u7684\u6837\u5b50"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# \u65b0\u521b\u5efa\u7684\u653e\u5230default\u91cc\n[default]\naws_access_key_id = new-xxxxxx\naws_secret_access_key = new-yyyyyyyyy\n\n# \u539f\u6765\u7684 default \u6539\u4e3a\u4e86 gtihub\n[github]\naws_access_key_id = xxxxxx\naws_secret_access_key = yyyyyyyyy\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u901a\u8fc7\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"p"},"export AWS_PROFILE=default")," \u53ef\u4ee5\u5207\u6362\u4f7f\u7528\u54ea\u4e2asection")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u9a8c\u8bc1\u6743\u9650\u662f\u5426\u6b63\u5e38")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl cluster-info\n# \u6216\nkubectl get pods\n# \u4f1a\u8f93\u51fa\u5bf9\u5e94\u7684pod \u6216\u8005 No resources found in default namespace.\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u6267\u884c\u65f6\u5148\u5207\u6362\u4e3a",(0,l.kt)("inlineCode",{parentName:"p"},"export AWS_PROFILE=default"),"\uff0c\u518d\u5207\u6362\u56de ",(0,l.kt)("inlineCode",{parentName:"p"},"export AWS_PROFILE=github"),"\n\u518d\u6267\u884c ",(0,l.kt)("inlineCode",{parentName:"p"},"kubectl cluster-info")," \u6ca1\u6709\u62a5\u9519\u5373\u53ef")),(0,l.kt)("h2",{id:"\u6dfb\u52a0\u673a\u5668"},"\u6dfb\u52a0\u673a\u5668"),(0,l.kt)("h3",{id:"\u6dfb\u52a0node"},"\u6dfb\u52a0node"),(0,l.kt)("p",null,"\u5728 ",(0,l.kt)("inlineCode",{parentName:"p"},"Clusters")," \u4e0b\u7684 ",(0,l.kt)("inlineCode",{parentName:"p"},"Configuration")," \u91cc\uff0c\u627e\u5230 Compute \u9009\u9879\u5361\uff0c\u5728\u4e0b\u9762\u6709\u4e00\u4e2a ",(0,l.kt)("inlineCode",{parentName:"p"},"Node Groups"),", \u70b9\u51fb\u6dfb\u52a0 ",(0,l.kt)("inlineCode",{parentName:"p"},"Add Node Group"),".",(0,l.kt)("br",{parentName:"p"}),"\n","\u586b\u5199 GroupName\u3002"),(0,l.kt)("h3",{id:"\u914d\u7f6enode"},"\u914d\u7f6enode"),(0,l.kt)("p",null,"\u70b9\u51fb \u4e0a\u9762\u914d\u7f6e\u597d\u7684 ",(0,l.kt)("inlineCode",{parentName:"p"},"Group name"),", \u8fdb\u5165 ",(0,l.kt)("inlineCode",{parentName:"p"},"Node Group Configuration"),", \u5728 Details \u627e\u5230 ",(0,l.kt)("inlineCode",{parentName:"p"},"Autoscaling group name"),", \u70b9\u51fb\u8fdb\u5165\n\u914d\u7f6eEC2\u7684\u671f\u671b\u6570\u91cf\u3001\u6700\u5c0f\u6570\u91cf\u548c\u6700\u5927\u6570\u91cf\u3002"),(0,l.kt)("h2",{id:"\u90e8\u7f72\u5e94\u7528\u5230eks"},"\u90e8\u7f72\u5e94\u7528\u5230EKS"),(0,l.kt)("p",null,"\u4f7f\u7528\u524d\u9700\u8981\u786e\u4fdd ",(0,l.kt)("inlineCode",{parentName:"p"},"github-ci")," \u7528\u6237\u62e5\u6709 ",(0,l.kt)("inlineCode",{parentName:"p"},"SecretsManagerReadWrite")," \u6743\u9650\u3002"),(0,l.kt)("h3",{id:"\u521b\u5efaaws\u8ba4\u8bc1"},"\u521b\u5efaaws\u8ba4\u8bc1"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"# aws-auth.yaml\napiVersion: v1 \nkind: ConfigMap \nmetadata: \n  name: aws-auth \n  namespace: kube-system \ndata: \n  mapUsers: | \n    - userarn: arn:aws:iam::111222333:user/github-ci\n      username: github-ci\n      groups:\n        - system:masters\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"username \u548c userarn \u9700\u8981\u6539\u4e3a\u81ea\u5df1\u7684")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl apply -f aws-auth.yaml\n")),(0,l.kt)("p",null,"\u5982\u679c\u5e94\u7528\u627e\u4e0d\u5230\u6216\u8005\u6ca1\u6709\u6267\u884c\u6743\u9650\u4f1a\u62a5\u4ee5\u4e0b\u9519\u8bef\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'Error: failed to create containerd task: failed to create shim task: OCI runtime create failed: runc create failed: unable to start container process: exec: "/bin/xxxx": permission denied: unknown\n')),(0,l.kt)("h3",{id:"\u90e8\u7f72deploy\u548cservice"},"\u90e8\u7f72deploy\u548cservice"),(0,l.kt)("p",null,"\u914d\u7f6e\u5982\u4e0b"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},'# deployment.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: microservice-api-deployment\n  labels:\n    app: microservice-api\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: microservice-api\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 1\n  template:\n    metadata:\n      labels:\n        app: microservice-api\n    spec:\n      containers:\n      - name: microservice-api\n        image: xxxxx.dkr.ecr.eu-west-1.amazonaws.com/microservice:latest\n        imagePullPolicy: Always\n        resources:\n          limits:\n            memory: "128Mi"\n            cpu: "100m" # 0.1\u6838\uff0c1000m = 1\u6838\u5fc3\n        ports:\n        - containerPort: 8080\n\n# service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: microservice-api-service\nspec:\n  selector:\n    app: microservice-api\n  ports:\n    - protocol: TCP\n      port: 80\n      targetPort: 8080\n  type: LoadBalancer\n')),(0,l.kt)("p",null,"\u6b64\u65f6EKS\u4f1a\u4e3a\u5176\u5206\u914d\u4e00\u4e2a ",(0,l.kt)("inlineCode",{parentName:"p"},"External-IP"),", \u4f7f\u7528\u8be5IP\u5c31\u53ef\u4ee5\u76f4\u63a5\u8bbf\u95ee\u3002\u5177\u4f53\u53ef\u4ee5\u5728k9s\u91cc\u8fdb\u884c\u67e5\u770b\u3002"),(0,l.kt)("p",null,"\u53ef\u4ee5\u901a\u8fc7 nslookup \u8fdb\u884c\u67e5\u770b:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"nslookup xxxxxx-yyyyy.ap-southeast-1.elb.amazonaws.com\n")),(0,l.kt)("p",null,"\u4f1a\u53d1\u73b0\u627e\u4e0d\u5230\u6307\u5b9a\u7684\u57df\u540d\u3002\u8fd9\u65f6\u9700\u8981\u7b49\u5f85\u4e00\u4f1a\u5373\u53ef\u3002\u8fd9\u65f6\u5c31\u53ef\u4ee5\u4f7f\u7528\u8be5\u57df\u540d\u8bbf\u95ee\u6211\u4eec\u7684\u670d\u52a1\u4e86\u3002",(0,l.kt)("br",{parentName:"p"}),"\n","\u4f46\u662f\u8fd9\u4e2a\u57df\u540d\u592a\u957f\u4e0d\u597d\u8bb0\u5fc6\uff0c\u6211\u4eec\u9700\u8981\u7533\u8bf7\u4e00\u4e2a\u57df\u540d\u6765\u8fdb\u884c\u8bbf\u95ee\u3002"),(0,l.kt)("h3",{id:"\u7533\u8bf7\u57df\u540d"},"\u7533\u8bf7\u57df\u540d"),(0,l.kt)("p",null,"\u8fd9\u91cc\u4ee5\u7533\u8bf7 ",(0,l.kt)("inlineCode",{parentName:"p"},"api.go-eagle.org")," \u4e3a\u4f8b"),(0,l.kt)("p",null,"\u5728 Route53\u91cc\u7533\u8bf7\u5373\u53ef\uff0c\u8fd9\u91cc\u4e0d\u8be6\u7ec6\u53d9\u8ff0\u4e86\u3002\u4f46\u6211\u4eec\u9700\u8981\u5728 ",(0,l.kt)("inlineCode",{parentName:"p"},"Route53")," -> ",(0,l.kt)("inlineCode",{parentName:"p"},"Hosted zones")," \u91cc\u6dfb\u52a0\u4e00\u6761A\u8bb0\u5f55."),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Record name: api"),(0,l.kt)("li",{parentName:"ul"},"Record type: A record"),(0,l.kt)("li",{parentName:"ul"},"Value: \u8fd9\u4e2a\u5f88\u5173\u952e\uff0c\u6211\u4eec\u5728\u8fd9\u91cc\u6253\u5f00 ",(0,l.kt)("inlineCode",{parentName:"li"},"alias"),"\uff0c\u6b64\u65f6\u8be5\u9009\u9879\u4f1a\u53d8\u4e3a\uff1a",(0,l.kt)("inlineCode",{parentName:"li"},"Route traffic to"),", \u5e76\u9009\u62e9 ",(0,l.kt)("inlineCode",{parentName:"li"},"Alias to Network Load Balancer")," \u53ca\u5bf9\u5e94\u7684\u5927\u533a\uff0c\u7136\u540e\u628a\u4e0a\u9762\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"xxxxxx-yyyyy.ap-southeast-1.elb.amazonaws.com")," \u586b\u5165 ",(0,l.kt)("inlineCode",{parentName:"li"},"Network Load Balancer")," \u5373\u53ef\u3002")),(0,l.kt)("p",null,"\u606d\u559c\uff0c\u6b64\u65f6\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u57df\u540d ",(0,l.kt)("inlineCode",{parentName:"p"},"api.go-eagle.org")," \u8bbf\u95ee\u6211\u4eec\u7684\u670d\u52a1\u4e86\u3002"),(0,l.kt)("h3",{id:"\u90e8\u7f72ingress"},"\u90e8\u7f72ingress"),(0,l.kt)("p",null,"\u5927\u5bb6\u6709\u6ca1\u6709\u53d1\u73b0\u4e0a\u9762\u7684\u95ee\u9898\uff1f\u5982\u679c\u662f\u8bbf\u95ee\u591a\u4e2a Service \u600e\u4e48\u529e\uff1f \u7533\u8bf7\u591a\u4e2a\u57df\u540d\uff1f\n\u5176\u5b9ek8s\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u79cd\u65b9\u5f0f\uff0c\u90a3\u5c31\u662f ",(0,l.kt)("inlineCode",{parentName:"p"},"ingress"),", \u5b83\u53ef\u4ee5\u5e2e\u6211\u4eec\u6839\u636e\u4e00\u5b9a\u7684\u89c4\u5219\u8def\u7531\u5230\u4e0d\u540c\u7684 service \u91cc\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},'# ingress.yaml\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: microservice-api-ingress\nspec:\n  ingressClassName: nginx\n  rules:\n  - host: "api.go-eagle.org"\n    http:\n      paths:\n      - pathType: Prefix\n        path: "/"\n        backend:\n          service:\n            name: microservice-api-service\n            port:\n              number: 80\n')),(0,l.kt)("p",null,"\u4f46\u662f\u4ec5\u4ec5\u6709 ",(0,l.kt)("inlineCode",{parentName:"p"},"ingress")," \u8fd8\u4e0d\u4f1a\u751f\u6548\uff0c\u5fc5\u987b\u642d\u914d ",(0,l.kt)("inlineCode",{parentName:"p"},"ingress controller"),"(\u53ef\u4ee5\u67e5\u770b\uff1a",(0,l.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/services-networking/ingress/#prerequisites"},"ingress \u5148\u51b3\u6761\u4ef6"),")\u3002"),(0,l.kt)("h3",{id:"\u5b89\u88c5-ingress-controller"},"\u5b89\u88c5 ingress controller"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.7.1/deploy/static/provider/aws/deploy.yaml\n")),(0,l.kt)("p",null,"\u5b89\u88c5\u5b8c\u540e\uff0c\u53ef\u4ee5\u67e5\u770bpod, \u6b64\u65f6\u5e94\u8be5\u4f1a\u770b\u5230\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"NAMESPACE       NAME\ningress-nginx   ingress-nginx-controller-xxxxxxx-yyyy\n")),(0,l.kt)("p",null,"\u67e5\u770bingress"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"NAMESPACE    NAME                       CLASS   ADDRESS\ndefault      microservice-api-ingress   NONE    # \u8fd9\u91cc\u7ed9\u81ea\u52a8\u5206\u914d\u4e86\u4e00\u4e2aNLB\n")),(0,l.kt)("p",null,"\u6ce8\u610f\u8fd9\u91cc\u7684NLB\u5730\u5740\u4e0e\u4e4b\u524d\u6dfb\u52a0\u7684A\u8bb0\u5f55\u7684\u5730\u5740\u4e0d\u540c\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5c06\u4e4b\u524d\u7684A\u8bb0\u5f55\u7684value\u6539\u4e3a\u8fd9\u91cc\u65b0\u751f\u6210\u7684\u3002"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u53c2\u8003\u81ea\uff1a",(0,l.kt)("a",{parentName:"p",href:"https://kubernetes.github.io/ingress-nginx/deploy/#aws"},"https://kubernetes.github.io/ingress-nginx/deploy/#aws"))),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"ingress")," \u5168\u90e8\u914d\u7f6e\u5982\u4e0b:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},'# ingress.yaml\napiVersion: networking.k8s.io/v1\nkind: IngressClass\nmetadata:\n  name: nginx\nspec:\n  controller: k8s.io/ingress-nginx\n---\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: microservice-api-ingress\nspec:\n  ingressClassName: nginx\n  rules:\n  - host: "api.go-eagle.org"\n    http:\n      paths:\n      - pathType: Prefix\n        path: "/"\n        backend:\n          service:\n            name: microservice-api-service\n            port:\n              number: 80\n')),(0,l.kt)("p",null,"\u6b64\u65f6\u6211\u4eec\u7684 service \u7c7b\u578b\u9700\u8981\u4fee\u6539\u4e3a ",(0,l.kt)("inlineCode",{parentName:"p"},"ClusterIP"),"\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"# service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: microservice-api-service\nspec:\n  selector:\n    app: microservice-api\n  ports:\n    - protocol: TCP\n      port: 80\n      targetPort: 8080\n  type: ClusterIP # \u4ece LoadBalancer \u6539\u4e3a ClusterIP\n")),(0,l.kt)("p",null,"\u91cd\u65b0\u90e8\u7f72"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl apply -f go-service.yaml\nkubectl apply -f go-ingress.yaml\n")),(0,l.kt)("h3",{id:"\u914d\u7f6etls\u8bc1\u4e66"},"\u914d\u7f6eTLS\u8bc1\u4e66"),(0,l.kt)("h3",{id:"\u4f7f\u7528github-actions-\u81ea\u52a8\u90e8\u7f72\u5230eks"},"\u4f7f\u7528Github Actions \u81ea\u52a8\u90e8\u7f72\u5230EKS"),(0,l.kt)("h4",{id:"1\u5b89\u88c5-kubectl\u548c\u66f4\u65b0\u914d\u7f6e"},"1\u3001\u5b89\u88c5 kubectl\u548c\u66f4\u65b0\u914d\u7f6e"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"# .github/workfolows/depoly.yaml\n# \u65b0\u589e\u5982\u4e0b\u7247\u6bb5\n...\n    - name: Install kubectl\n      uses: azure/setup-kubectl@v3\n      with:\n        version: 'v1.26' # default is latest stable\n      id: install\n...\n    - name: Update kube config\n      run: aws eks update-kubeconfig --name microservice --region ap-southeast-1\n...\n")),(0,l.kt)("h4",{id:"2\u90e8\u7f72\u955c\u50cf\u5230eks"},"2\u3001\u90e8\u7f72\u955c\u50cf\u5230EKS"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"# .github/workfolows/depoly.yaml\n# \u65b0\u589e\u5982\u4e0b\u7247\u6bb5\n...\n    - name: Deploy image to Amazon EKS\n      run: |\n        kubectl apply -f deploy/k8s/aws-auth.yaml\n        kubectl apply -f deploy/k8s/go-deployment.yaml\n        kubectl apply -f deploy/k8s/go-service.yaml\n        kubectl apply -f deploy/k8s/go-ingress.yaml\n...\n")),(0,l.kt)("p",null,"\u5b8c\u6574\u4ee3\u7801\u5982\u4e0b"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},'# .github/workfolows/depoly.yaml\nname: Deploy\n\non:\n  push:\n    tags:\n    - \'v*.*.*\'\n\njobs:\n\n  deploy:\n    name: Build image\n    runs-on: ubuntu-latest\n\n    # These permissions are needed to interact with GitHub\'s OIDC Token endpoint.\n    permissions:\n      id-token: write\n      contents: read\n\n    steps:\n    - name: Checkout code\n      uses: actions/checkout@v3\n\n    - name: Install kubectl\n      uses: azure/setup-kubectl@v3\n      with:\n        version: \'v1.26\' # default is latest stable\n      id: install\n\n    - name: Configure AWS credentials\n      uses: aws-actions/configure-aws-credentials@v2\n      with:\n        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}\n        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}\n        aws-region: us-east-1\n\n    - name: Login to Amazon ECR\n      id: login-ecr\n      uses: aws-actions/amazon-ecr-login@v1\n\n    - name: Set env\n      run: echo "RELEASE_VERSION=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV\n\n    - name: Build, tag, and push image to Amazon ECR\n      env:\n        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}\n        ECR_REPOSITORY: microservices\n        IMAGE_TAG: ${{ env.RELEASE_VERSION }}\n      run: |\n        echo "Tag name from GITHUB_REF_NAME: $GITHUB_REF_NAME"\n        echo "Tag name from github.ref_name: ${{  github.ref_name }}"\n        echo $RELEASE_VERSION\n        echo ${{ env.RELEASE_VERSION }}\n        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .\n        docker push -a $ECR_REGISTRY/$ECR_REPOSITORY\n\n    - name: Update kube config\n      run: aws eks update-kubeconfig --name microservice --region ap-southeast-1\n\n    - name: Deploy image to Amazon EKS\n      run: |\n        kubectl apply -f deploy/k8s/aws-auth.yaml\n        kubectl apply -f deploy/k8s/go-deployment.yaml\n        kubectl apply -f deploy/k8s/go-service.yaml\n        kubectl apply -f deploy/k8s/go-ingress.yaml\n')),(0,l.kt)("h2",{id:"k9s\u4f7f\u7528"},"k9s\u4f7f\u7528"),(0,l.kt)("p",null,"\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5b98\u65b9\u63d0\u4f9b\u7684 ",(0,l.kt)("inlineCode",{parentName:"p"},"kubectl")," \u547d\u4ee4\u8fdb\u884c\u5404\u79cd\u64cd\u4f5c\u3002\u4e0d\u8fc7\u53ef\u80fd\u9700\u8981\u8bb0\u4f4f\u5404\u79cd\u53c2\u6570\uff0c\u8fd9\u91cc\u63a8\u8350\u4e00\u4e2a\u5c0f\u5de5\u5177\uff1ak9s"),(0,l.kt)("h3",{id:"\u5b89\u88c5-k9s"},"\u5b89\u88c5 k9s"),(0,l.kt)("p",null,"k9s\u5b98\u7f51\uff1a",(0,l.kt)("a",{parentName:"p",href:"https://k9scli.io/"},"https://k9scli.io/"),"\ngithub: ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/derailed/k9s"},"https://github.com/derailed/k9s")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# for macOS\nbrew install derailed/k9s/k9s\n")),(0,l.kt)("h3",{id:"k9s\u7684\u4f7f\u7528"},"k9s\u7684\u4f7f\u7528"),(0,l.kt)("p",null,"\u5b89\u88c5\u540e\uff0c \u76f4\u63a5\u6267\u884c ",(0,l.kt)("inlineCode",{parentName:"p"},"k9s")," \u76f4\u63a5\u8fdb\u5165\u56fe\u7247\u8bdd\u754c\u9762\u8fdb\u884c\u64cd\u4f5c\uff0c\u975e\u5e38\u65b9\u4fbf\u3002"),(0,l.kt)("h2",{id:"reference"},"Reference"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://repost.aws/zh-Hans/knowledge-center/amazon-eks-cluster-access"},"https://repost.aws/zh-Hans/knowledge-center/amazon-eks-cluster-access")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://www.youtube.com/watch?v=hwMevai3_wQ"},"https://www.youtube.com/watch?v=hwMevai3_wQ")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/"},"https://kubernetes.io/docs/")),(0,l.kt)("li",{parentName:"ul"},"k8s\u5b98\u65b9 ingress controller: ",(0,l.kt)("a",{parentName:"li",href:"https://github.com/kubernetes/ingress-nginx"},"https://github.com/kubernetes/ingress-nginx")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://kubernetes.github.io/ingress-nginx/deploy/"},"https://kubernetes.github.io/ingress-nginx/deploy/"))))}k.isMDXComponent=!0}}]);