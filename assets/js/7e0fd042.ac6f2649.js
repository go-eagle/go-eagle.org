"use strict";(self.webpackChunkgo_eagle_org_2=self.webpackChunkgo_eagle_org_2||[]).push([[4426],{3905:function(e,n,t){t.d(n,{Zo:function(){return s},kt:function(){return u}});var r=t(7294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function p(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function a(e,n){if(null==e)return{};var t,r,i=function(e,n){if(null==e)return{};var t,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var c=r.createContext({}),l=function(e){var n=r.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):p(p({},n),e)),t},s=function(e){var n=l(e.components);return r.createElement(c.Provider,{value:n},e.children)},g={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},d=r.forwardRef((function(e,n){var t=e.components,i=e.mdxType,o=e.originalType,c=e.parentName,s=a(e,["components","mdxType","originalType","parentName"]),d=l(t),u=i,h=d["".concat(c,".").concat(u)]||d[u]||g[u]||o;return t?r.createElement(h,p(p({ref:n},s),{},{components:t})):r.createElement(h,p({ref:n},s))}));function u(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var o=t.length,p=new Array(o);p[0]=d;var a={};for(var c in n)hasOwnProperty.call(n,c)&&(a[c]=n[c]);a.originalType=e,a.mdxType="string"==typeof e?e:i,p[1]=a;for(var l=2;l<o;l++)p[l]=t[l];return r.createElement.apply(null,p)}return r.createElement.apply(null,t)}d.displayName="MDXCreateElement"},146:function(e,n,t){t.r(n),t.d(n,{contentTitle:function(){return c},default:function(){return d},frontMatter:function(){return a},metadata:function(){return l},toc:function(){return s}});var r=t(7462),i=t(3366),o=(t(7294),t(3905)),p=["components"],a={id:"grpc",title:"gRPC",description:"Eagle \u4e00\u5957\u8f7b\u91cf\u7ea7 Go \u5fae\u670d\u52a1\u6846\u67b6\uff0c\u5305\u542b\u5927\u91cf\u5fae\u670d\u52a1\u76f8\u5173\u6846\u67b6\u53ca\u5de5\u5177",keywords:["Go","Eagle","Toolkit","Framework","Microservices","HTTP"],slug:"/component/transport/grpc"},c=void 0,l={unversionedId:"component/transport/grpc",id:"component/transport/grpc",isDocsHomePage:!1,title:"gRPC",description:"Eagle \u4e00\u5957\u8f7b\u91cf\u7ea7 Go \u5fae\u670d\u52a1\u6846\u67b6\uff0c\u5305\u542b\u5927\u91cf\u5fae\u670d\u52a1\u76f8\u5173\u6846\u67b6\u53ca\u5de5\u5177",source:"@site/docs/component/transport/grpc.md",sourceDirName:"component/transport",slug:"/component/transport/grpc",permalink:"/docs/component/transport/grpc",editUrl:"https://github.com/go-eagle/go-eagle.org/edit/main/docs/component/transport/grpc.md",version:"current",frontMatter:{id:"grpc",title:"gRPC",description:"Eagle \u4e00\u5957\u8f7b\u91cf\u7ea7 Go \u5fae\u670d\u52a1\u6846\u67b6\uff0c\u5305\u542b\u5927\u91cf\u5fae\u670d\u52a1\u76f8\u5173\u6846\u67b6\u53ca\u5de5\u5177",keywords:["Go","Eagle","Toolkit","Framework","Microservices","HTTP"],slug:"/component/transport/grpc"},sidebar:"docs",previous:{title:"HTTP",permalink:"/docs/component/transport/http"},next:{title:"\u642d\u5efaGo\u5f00\u53d1\u73af\u5883",permalink:"/docs/deployment/go-deploy"}},s=[{value:"Server",id:"server",children:[{value:"\u914d\u7f6e",id:"\u914d\u7f6e",children:[]},{value:"\u4e3b\u8981\u7684\u5b9e\u73b0\u7ec6\u8282",id:"\u4e3b\u8981\u7684\u5b9e\u73b0\u7ec6\u8282",children:[]},{value:"\u4f7f\u7528\u65b9\u5f0f",id:"\u4f7f\u7528\u65b9\u5f0f",children:[]}]},{value:"Client",id:"client",children:[{value:"\u914d\u7f6e",id:"\u914d\u7f6e-1",children:[]},{value:"\u4e3b\u8981\u7684\u5b9e\u73b0\u7ec6\u8282",id:"\u4e3b\u8981\u7684\u5b9e\u73b0\u7ec6\u8282-1",children:[]},{value:"\u4f7f\u7528\u65b9\u5f0f",id:"\u4f7f\u7528\u65b9\u5f0f-1",children:[]}]},{value:"References",id:"references",children:[]}],g={toc:s};function d(e){var n=e.components,t=(0,i.Z)(e,p);return(0,o.kt)("wrapper",(0,r.Z)({},g,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"transporter/grpc")," \u4e2d\u57fa\u4e8e\u8c37\u6b4c\u7684 ",(0,o.kt)("a",{parentName:"p",href:"https://www.grpc.io/"},"grpc")," \u6846\u67b6\u5b9e\u73b0\u4e86 ",(0,o.kt)("inlineCode",{parentName:"p"},"Transporter"),"\uff0c\u7528\u4ee5\u6ce8\u518c grpc \u5230 ",(0,o.kt)("inlineCode",{parentName:"p"},"eagle.Server()")," \u4e2d\u3002"),(0,o.kt)("h2",{id:"server"},"Server"),(0,o.kt)("h3",{id:"\u914d\u7f6e"},"\u914d\u7f6e"),(0,o.kt)("h4",{id:"networknetwork-string-serveroption"},(0,o.kt)("inlineCode",{parentName:"h4"},"Network(network string) ServerOption")),(0,o.kt)("p",null,"\u914d\u7f6e\u670d\u52a1\u7aef\u7684 network \u534f\u8bae\uff0c\u5982 tcp"),(0,o.kt)("h4",{id:"addressaddr-string-serveroption"},(0,o.kt)("inlineCode",{parentName:"h4"},"Address(addr string) ServerOption")),(0,o.kt)("p",null,"\u914d\u7f6e\u670d\u52a1\u7aef\u76d1\u542c\u7684\u5730\u5740"),(0,o.kt)("h4",{id:"timeouttimeout-timeduration-serveroption"},(0,o.kt)("inlineCode",{parentName:"h4"},"Timeout(timeout time.Duration) ServerOption")),(0,o.kt)("p",null,"\u914d\u7f6e\u670d\u52a1\u7aef\u7684\u8d85\u65f6\u8bbe\u7f6e"),(0,o.kt)("h4",{id:"enabletracing-serveroption"},(0,o.kt)("inlineCode",{parentName:"h4"},"EnableTracing() ServerOption")),(0,o.kt)("p",null,"\u542f\u7528\u670d\u52a1\u7aef\u7684\u94fe\u8def\u8ffd\u8e2a"),(0,o.kt)("h4",{id:"enablelog-serveroption"},(0,o.kt)("inlineCode",{parentName:"h4"},"EnableLog() ServerOption")),(0,o.kt)("p",null,"\u542f\u7528\u670d\u52a1\u7aef\u7684\u65e5\u5fd7"),(0,o.kt)("h4",{id:"unaryinterceptorin-grpcunaryserverinterceptor-serveroption"},(0,o.kt)("inlineCode",{parentName:"h4"},"UnaryInterceptor(in ...grpc.UnaryServerInterceptor) ServerOption")),(0,o.kt)("p",null,"\u914d\u7f6e\u670d\u52a1\u7aef\u4f7f\u7528\u7684 grpc \u5355\u5143\u62e6\u622a\u5668"),(0,o.kt)("h4",{id:"optionsopts-grpcserveroption-serveroption"},(0,o.kt)("inlineCode",{parentName:"h4"},"Options(opts ...grpc.ServerOption) ServerOption")),(0,o.kt)("p",null,"\u914d\u7f6e\u4e00\u4e9b\u989d\u5916\u7684 grpc.ServerOption"),(0,o.kt)("h3",{id:"\u4e3b\u8981\u7684\u5b9e\u73b0\u7ec6\u8282"},"\u4e3b\u8981\u7684\u5b9e\u73b0\u7ec6\u8282"),(0,o.kt)("h4",{id:"newserver"},(0,o.kt)("inlineCode",{parentName:"h4"},"NewServer()")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'func NewServer(opts ...ServerOption) *Server {\n    srv := &Server{\n        network: "tcp",\n        address: ":0",\n        timeout: 1 * time.Second,\n        health:  health.NewServer(),\n    }\n    for _, o := range opts {\n        o(srv)\n    }\n    // Unary\n    chainUnaryInterceptors := []grpc.UnaryServerInterceptor{\n        unaryServerInterceptor(srv),\n        grpcPrometheus.UnaryServerInterceptor,\n        grpcRecovery.UnaryServerInterceptor(),\n    }\n    if len(srv.inters) > 0 {\n        chainUnaryInterceptors = append(chainUnaryInterceptors, srv.inters...)\n    }\n\n    // stream\n    chainStreamInterceptors := []grpc.StreamServerInterceptor{\n        grpcPrometheus.StreamServerInterceptor,\n        grpcRecovery.StreamServerInterceptor(),\n    }\n\n    // enable tracing\n    if srv.enableTracing {\n        chainUnaryInterceptors = append(chainUnaryInterceptors, otelgrpc.UnaryServerInterceptor(srv.TracerOptions...))\n        chainStreamInterceptors = append(chainStreamInterceptors, otelgrpc.StreamServerInterceptor(srv.TracerOptions...))\n    }\n\n    // enable log\n    if srv.enableLog {\n        chainUnaryInterceptors = append(chainUnaryInterceptors, grpcZap.UnaryServerInterceptor(logger.GetZapLogger()))\n        chainStreamInterceptors = append(chainStreamInterceptors, grpcZap.StreamServerInterceptor(logger.GetZapLogger()))\n    }\n\n    grpcOpts := []grpc.ServerOption{\n        grpc.ChainUnaryInterceptor(chainUnaryInterceptors...),\n        grpc.ChainStreamInterceptor(chainStreamInterceptors...),\n    }\n    if len(srv.grpcOpts) > 0 {\n        grpcOpts = append(grpcOpts, srv.grpcOpts...)\n    }\n\n    grpcServer := grpc.NewServer(grpcOpts...)\n\n    // health check\n    healthPb.RegisterHealthServer(grpcServer, srv.health)\n\n    // register reflection and the interface can be debugged through the grpcurl tool\n    reflection.Register(grpcServer)\n\n    // set zero values for metrics registered for this grpc server\n    grpcPrometheus.Register(grpcServer)\n\n    srv.Server = grpcServer\n\n    return srv\n}\n}\n')),(0,o.kt)("h3",{id:"\u4f7f\u7528\u65b9\u5f0f"},"\u4f7f\u7528\u65b9\u5f0f"),(0,o.kt)("p",null,"\u7b80\u5355\u5217\u4e3e\u4e86\u4e00\u4e9b eagle \u4e2d grpc \u7684\u7528\u6cd5\uff0c\u5176\u4ed6 grpc \u7528\u6cd5\u53ef\u4ee5\u5230 grpc \u4ed3\u5e93\u4e2d\u67e5\u770b\u3002"),(0,o.kt)("h4",{id:"\u6ce8\u518c-grpc-server"},"\u6ce8\u518c grpc server"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'gs := grpc.NewServer()\napp := eagle.New(\n    eagle.Name("eagle"),\n    eagle.Version("v1.0.0"),\n    eagle.Server(gs),\n)\n')),(0,o.kt)("h2",{id:"client"},"Client"),(0,o.kt)("h3",{id:"\u914d\u7f6e-1"},"\u914d\u7f6e"),(0,o.kt)("h4",{id:"withendpointendpoint-string-clientoption"},(0,o.kt)("inlineCode",{parentName:"h4"},"WithEndpoint(endpoint string) ClientOption")),(0,o.kt)("p",null,"\u914d\u7f6e\u5ba2\u6237\u7aef\u4f7f\u7528\u7684\u5bf9\u7aef\u8fde\u63a5\u5730\u5740\uff0c\u5982\u679c\u4e0d\u4f7f\u7528\u670d\u52a1\u53d1\u73b0\u5219\u4e3aip:port,\u5982\u679c\u4f7f\u7528\u670d\u52a1\u53d1\u73b0\u5219\u683c\u5f0f\u4e3adiscovery://\\<authority",">","/\\<serviceName",">"),(0,o.kt)("h4",{id:"withtimeouttimeout-timeduration-clientoption"},(0,o.kt)("inlineCode",{parentName:"h4"},"WithTimeout(timeout time.Duration) ClientOption")),(0,o.kt)("p",null,"\u914d\u7f6e\u5ba2\u6237\u7aef\u7684\u8bf7\u6c42\u9ed8\u8ba4\u8d85\u65f6\u65f6\u95f4\uff0c\u5982\u679c\u6709\u94fe\u8def\u8d85\u65f6\u4f18\u5148\u4f7f\u7528\u94fe\u8def\u8d85\u65f6\u65f6\u95f4"),(0,o.kt)("h4",{id:"withmetric-clientoption"},(0,o.kt)("inlineCode",{parentName:"h4"},"WithMetric() ClientOption")),(0,o.kt)("p",null,"\u542f\u7528\u76d1\u63a7\u6307\u6807"),(0,o.kt)("h4",{id:"withlog-clientoption"},(0,o.kt)("inlineCode",{parentName:"h4"},"WithLog() ClientOption")),(0,o.kt)("p",null,"\u542f\u7528\u65e5\u5fd7"),(0,o.kt)("h4",{id:"withtracing-clientoption"},(0,o.kt)("inlineCode",{parentName:"h4"},"WithTracing() ClientOption")),(0,o.kt)("p",null,"\u542f\u7528\u94fe\u8def\u8ffd\u8e2a"),(0,o.kt)("h4",{id:"withkeepalive-clientoption"},(0,o.kt)("inlineCode",{parentName:"h4"},"WithKeepalive() ClientOption")),(0,o.kt)("p",null,"\u542f\u7528\u957f\u8fde\u63a5"),(0,o.kt)("h4",{id:"withgzip-clientoption"},(0,o.kt)("inlineCode",{parentName:"h4"},"WithGzip() ClientOption")),(0,o.kt)("p",null,"\u542f\u7528\u65e5\u5fd7\u538b\u7f29"),(0,o.kt)("h4",{id:"withoutretry-clientoption"},(0,o.kt)("inlineCode",{parentName:"h4"},"WithoutRetry() ClientOption")),(0,o.kt)("p",null,"\u542f\u7528\u91cd\u8bd5\u529f\u80fd"),(0,o.kt)("h4",{id:"withdiscoveryd-registrydiscovery-clientoption"},(0,o.kt)("inlineCode",{parentName:"h4"},"WithDiscovery(d registry.Discovery) ClientOption")),(0,o.kt)("p",null,"\u914d\u7f6e\u5ba2\u6237\u7aef\u670d\u52a1\u53d1\u73b0"),(0,o.kt)("h4",{id:"withunaryinterceptorin-grpcunaryclientinterceptor-clientoption"},(0,o.kt)("inlineCode",{parentName:"h4"},"WithUnaryInterceptor(in ...grpc.UnaryClientInterceptor) ClientOption")),(0,o.kt)("p",null,"\u914d\u7f6e\u5ba2\u6237\u7aef\u4f7f\u7528\u7684 grpc \u539f\u751f\u62e6\u622a\u5668"),(0,o.kt)("h4",{id:"withoptionsopts-grpcdialoption-clientoption"},(0,o.kt)("inlineCode",{parentName:"h4"},"WithOptions(opts ...grpc.DialOption) ClientOption")),(0,o.kt)("p",null,"\u914d\u7f6e\u4e00\u4e9b\u989d\u5916\u7684 grpc.ClientOption"),(0,o.kt)("h3",{id:"\u4e3b\u8981\u7684\u5b9e\u73b0\u7ec6\u8282-1"},"\u4e3b\u8981\u7684\u5b9e\u73b0\u7ec6\u8282"),(0,o.kt)("h4",{id:"dial"},(0,o.kt)("inlineCode",{parentName:"h4"},"dial()")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'func dial(ctx context.Context, insecure bool, opts ...ClientOption) (*grpc.ClientConn, error) {\n    // default client options\n    options := clientOptions{\n        timeout:         2000 * time.Millisecond,\n        balancerName:    roundrobin.Name,\n        enableGzip:      true,\n        enableMetric:    true,\n        disableRetry:    false,\n        NumRetries:      2,\n        enableKeepalive: true,\n        kp: keepalive.ClientParameters{\n            Time:                10 * time.Second,\n            Timeout:             time.Second,\n            PermitWithoutStream: false,\n        },\n    }\n    for _, opt := range opts {\n        opt(&options)\n    }\n\n    // merge inters\n    inters := []grpc.UnaryClientInterceptor{\n        unaryClientInterceptor(),\n    }\n    if len(options.inters) > 0 {\n        inters = append(inters, options.inters...)\n    }\n\n    // default dial option\n    dialOpts := []grpc.DialOption{\n        grpc.WithDefaultServiceConfig(fmt.Sprintf(`{"loadBalancingPolicy": "%s"}`, options.balancerName)),\n        grpc.WithChainUnaryInterceptor(inters...),\n    }\n    if len(options.dialOpts) > 0 {\n        dialOpts = append(dialOpts, options.dialOpts...)\n    }\n    // service discovery\n    if options.discovery != nil {\n        dialOpts = append(dialOpts, grpc.WithResolvers(discovery.NewBuilder(\n            options.discovery, discovery.WithInsecure(insecure))))\n    }\n    if insecure {\n        dialOpts = append(dialOpts, grpc.WithTransportCredentials(grpcInsecure.NewCredentials()))\n    } else {\n        tlsConfig := &tls.Config{\n            InsecureSkipVerify: true,\n        }\n        cred := credentials.NewTLS(tlsConfig)\n        dialOpts = append(dialOpts, grpc.WithTransportCredentials(cred))\n    }\n    if options.enableKeepalive {\n        kp := keepalive.ClientParameters{\n            Time:                options.kp.Time,\n            Timeout:             options.kp.Timeout,\n            PermitWithoutStream: options.kp.PermitWithoutStream,\n        }\n        dialOpts = append(dialOpts, grpc.WithKeepaliveParams(kp))\n    }\n    if options.enableGzip {\n        dialOpts = append(dialOpts, grpc.WithDefaultCallOptions(grpc.UseCompressor(gzip.Name)))\n    }\n    if options.enableMetric {\n        dialOpts = append(dialOpts,\n            grpc.WithChainUnaryInterceptor(grpcPrometheus.UnaryClientInterceptor),\n            grpc.WithChainStreamInterceptor(grpcPrometheus.StreamClientInterceptor),\n        )\n    }\n    // enable tracing\n    if options.enableTracing {\n        dialOpts = append(dialOpts,\n            grpc.WithChainUnaryInterceptor(otelgrpc.UnaryClientInterceptor()),\n            grpc.WithChainStreamInterceptor(otelgrpc.StreamClientInterceptor()),\n        )\n    }\n    if options.enableLog {\n        dialOpts = append(dialOpts,\n            grpc.WithChainUnaryInterceptor(grpcZap.UnaryClientInterceptor(logger.GetZapLogger())),\n            grpc.WithChainStreamInterceptor(grpcZap.StreamClientInterceptor(logger.GetZapLogger())),\n        )\n    }\n    if !options.disableRetry {\n        dialOpts = append(dialOpts,\n            grpc.WithDefaultServiceConfig(getRetryPolicy(options.balancerName, options.NumRetries)),\n        )\n    }\n\n    return grpc.DialContext(ctx, options.endpoint, dialOpts...)\n}\n\n')),(0,o.kt)("h3",{id:"\u4f7f\u7528\u65b9\u5f0f-1"},"\u4f7f\u7528\u65b9\u5f0f"),(0,o.kt)("h4",{id:"\u521b\u5efa\u5ba2\u6237\u7aef\u8fde\u63a5"},"\u521b\u5efa\u5ba2\u6237\u7aef\u8fde\u63a5"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'conn, err := grpc.DialInsecure(\n        context.Background(),\n        grpc.WithEndpoint("127.0.0.1:9000"),\n    )\n')),(0,o.kt)("h4",{id:"\u4f7f\u7528\u670d\u52a1\u53d1\u73b0"},"\u4f7f\u7528\u670d\u52a1\u53d1\u73b0"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'conn, err := grpc.DialInsecure(\n    context.Background(),\n    grpc.WithEndpoint("discovery:///helloworld"),\n    grpc.WithDiscovery(r),\n)\n')),(0,o.kt)("h2",{id:"references"},"References"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://www.grpc.io/"},"https://www.grpc.io/")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://www.grpc.io/docs/languages/go/quickstart/"},"https://www.grpc.io/docs/languages/go/quickstart/")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/grpc/grpc-go"},"https://github.com/grpc/grpc-go"))))}d.isMDXComponent=!0}}]);