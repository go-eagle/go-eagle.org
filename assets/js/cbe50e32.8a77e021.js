"use strict";(self.webpackChunkgo_eagle_org_3=self.webpackChunkgo_eagle_org_3||[]).push([[7496],{8453:(n,e,r)=>{r.d(e,{R:()=>c,x:()=>o});var i=r(6540);const s={},l=i.createContext(s);function c(n){const e=i.useContext(l);return i.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:c(n.components),i.createElement(l.Provider,{value:e},n.children)}},8681:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>c,metadata:()=>i,toc:()=>t});const i=JSON.parse('{"id":"best-practices/engineering","title":"\u4ee3\u7801\u6700\u4f73\u5b9e\u8df5 - \u5de5\u7a0b\u7bc7","description":"\u4ee3\u7801\u6700\u4f73\u5b9e\u8df5 - \u5de5\u7a0b\u7bc7","source":"@site/docs/best-practices/engineering.md","sourceDirName":"best-practices","slug":"/best-practices/engineering","permalink":"/docs/best-practices/engineering","draft":false,"unlisted":false,"editUrl":"https://github.com/go-eagle/go-eagle.org/edit/main/docs/best-practices/engineering.md","tags":[],"version":"current","frontMatter":{"id":"engineering","title":"\u4ee3\u7801\u6700\u4f73\u5b9e\u8df5 - \u5de5\u7a0b\u7bc7","description":"\u4ee3\u7801\u6700\u4f73\u5b9e\u8df5 - \u5de5\u7a0b\u7bc7","keywords":["Go","Eagle","Toolkit","Framework","Microservices","HTTP"],"slug":"/best-practices/engineering"},"sidebar":"docs","previous":{"title":"\u4ee3\u7801\u6700\u4f73\u5b9e\u8df5 - \u7ec4\u4ef6\u7bc7","permalink":"/docs/best-practices/components"},"next":{"title":"\u4ee3\u7801\u6700\u4f73\u5b9e\u8df5 - \u8bed\u8a00\u7bc7","permalink":"/docs/best-practices/language"}}');var s=r(4848),l=r(8453);const c={id:"engineering",title:"\u4ee3\u7801\u6700\u4f73\u5b9e\u8df5 - \u5de5\u7a0b\u7bc7",description:"\u4ee3\u7801\u6700\u4f73\u5b9e\u8df5 - \u5de5\u7a0b\u7bc7",keywords:["Go","Eagle","Toolkit","Framework","Microservices","HTTP"],slug:"/best-practices/engineering"},o=void 0,d={},t=[{value:"\u9879\u76ee\u7ed3\u6784",id:"\u9879\u76ee\u7ed3\u6784",level:2},{value:"\u914d\u7f6e\u6587\u4ef6",id:"\u914d\u7f6e\u6587\u4ef6",level:2},{value:"\u65e5\u5fd7\u6253\u5370",id:"\u65e5\u5fd7\u6253\u5370",level:2},{value:"\u65e5\u5fd7\u89c4\u8303",id:"\u65e5\u5fd7\u89c4\u8303",level:3},{value:"\u7ed3\u6784\u4f53\u6253\u5370",id:"\u7ed3\u6784\u4f53\u6253\u5370",level:3},{value:"\u9519\u8bef\u5904\u7406",id:"\u9519\u8bef\u5904\u7406",level:2},{value:"error \u8fd4\u56de",id:"error-\u8fd4\u56de",level:3},{value:"error \u5224\u65ad",id:"error-\u5224\u65ad",level:3},{value:"panic \u6392\u67e5",id:"panic-\u6392\u67e5",level:3},{value:"client \u521d\u59cb\u5316\u62a5\u9519\u5904\u7406",id:"client-\u521d\u59cb\u5316\u62a5\u9519\u5904\u7406",level:3},{value:"\u5e38\u7528\u7ec4\u4ef6error\u5224\u65ad",id:"\u5e38\u7528\u7ec4\u4ef6error\u5224\u65ad",level:3},{value:"MySQL GORM \u7684 ErrRecordNotFound",id:"mysql-gorm-\u7684-errrecordnotfound",level:4},{value:"Redis redis.Nil \u9519\u8bef",id:"redis-redisnil-\u9519\u8bef",level:4},{value:"\u6240\u6709\u534f\u7a0b\u90fd\u8981defer\u5904\u7406panic",id:"\u6240\u6709\u534f\u7a0b\u90fd\u8981defer\u5904\u7406panic",level:3},{value:"\u9ad8\u5e76\u53d1",id:"\u9ad8\u5e76\u53d1",level:2},{value:"\u52a0\u9501\u907f\u514dio\u76f8\u5173\u64cd\u4f5c",id:"\u52a0\u9501\u907f\u514dio\u76f8\u5173\u64cd\u4f5c",level:3},{value:"\u9501\u7684\u6700\u4f73\u5b9e\u8df5",id:"\u9501\u7684\u6700\u4f73\u5b9e\u8df5",level:3},{value:"\u51cf\u5c11\u6301\u6709\u65f6\u95f4",id:"\u51cf\u5c11\u6301\u6709\u65f6\u95f4",level:4},{value:"\u5584\u7528 defer",id:"\u5584\u7528-defer",level:4},{value:"\u4f18\u5316\u9501\u7684\u7c92\u5ea6",id:"\u4f18\u5316\u9501\u7684\u7c92\u5ea6",level:4},{value:"\u8bfb\u5199\u5206\u79bb",id:"\u8bfb\u5199\u5206\u79bb",level:4},{value:"\u4f7f\u7528\u539f\u5b50\u64cd\u4f5c",id:"\u4f7f\u7528\u539f\u5b50\u64cd\u4f5c",level:4},{value:"\u7b80\u5355\u5e76\u53d1\u5e93",id:"\u7b80\u5355\u5e76\u53d1\u5e93",level:3},{value:"\u5e76\u53d1\u9650\u5236",id:"\u5e76\u53d1\u9650\u5236",level:4}];function a(n){const e={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.h2,{id:"\u9879\u76ee\u7ed3\u6784",children:"\u9879\u76ee\u7ed3\u6784"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"// todo\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u914d\u7f6e\u6587\u4ef6",children:"\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u8ddf\u73af\u5883\u76f8\u5173\u7684\u914d\u7f6e\uff0c\u90fd\u4f7f\u7528 ",(0,s.jsx)(e.code,{children:"yaml"})," \u914d\u7f6e\u6587\u4ef6\u7684\u65b9\u5f0f\uff0c\u800c\u4e0d\u662f\u91c7\u7528 ",(0,s.jsx)(e.code,{children:"constants"})," \u5e38\u91cf\u65b9\u5f0f\uff0c\u5c31\u4e0d\u9700\u8981\u5728\u4ee3\u7801\u5c42\u9762\u52a0\u4e0a\u5404\u79cd\u73af\u5883\u5224\u65ad"]}),"\n",(0,s.jsxs)(e.li,{children:["\u672c\u5730\u914d\u7f6e\u6587\u4ef6\u7ed3\u6784\u4f53\u5b9a\u4e49\u5728 ",(0,s.jsx)(e.code,{children:"config"})," \u76ee\u5f55\u4e0b\uff0c\u914d\u7f6e\u6587\u4ef6\u5206\u73af\u5883\u653e\u5230\u5bf9\u5e94\u7684\u76ee\u5f55\u91cc"]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"// config\n\u251c\u2500\u2500 dev\n\u2502\xa0\xa0 \u251c\u2500\u2500 app.yaml\n\u2502\xa0\xa0 \u251c\u2500\u2500 database.yaml\n\u2502\xa0\xa0 \u251c\u2500\u2500 logger.yaml\n\u2502\xa0\xa0 \u251c\u2500\u2500 redis.yaml\n\u2502\xa0\xa0 \u2514\u2500\u2500 trace.yaml\n\u251c\u2500\u2500 test\n\u251c\u2500\u2500 prod\n\u251c\u2500\u2500 config.go // \u81ea\u5b9a\u4e49\u5185\u5bb9\u53ef\u4ee5\u653e\u8fd9\u91cc\n\u2514\u2500\u2500 docker\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u65e5\u5fd7\u6253\u5370",children:"\u65e5\u5fd7\u6253\u5370"}),"\n",(0,s.jsx)(e.h3,{id:"\u65e5\u5fd7\u89c4\u8303",children:"\u65e5\u5fd7\u89c4\u8303"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u6253\u65e5\u5fd7\u662f\u4e3a\u4e86\u65b9\u4fbf\u6392\u67e5\u95ee\u9898\uff0c\u8981\u4fdd\u8bc1\u5173\u952e\u4fe1\u606f\u548c\u4e0a\u4e0b\u6587\u4e0d\u4f1a\u7f3a\u5931\u3002\u5206\u5c42\u8c03\u7528\u7684\u60c5\u51b5\u4e0b\uff0c\u4f8b\u5982 ",(0,s.jsx)(e.code,{children:"dal"})," \u5c42\u5982\u679c\u4e0d\u6253\u5370\u65e5\u5fd7\uff0c\u5e94\u8be5 ",(0,s.jsx)(e.code,{children:"warp"})," \u4e0b ",(0,s.jsx)(e.code,{children:"error"})," \u4fdd\u8bc1\u4e0a\u5c42\u8c03\u7528\u6709\u8db3\u591f\u591a\u7684\u4e0a\u4e0b\u6587"]}),"\n",(0,s.jsxs)(e.li,{children:["\u51cf\u5c11 ",(0,s.jsx)(e.code,{children:"info"})," \u65e5\u5fd7\u91cf\uff0c\u907f\u514d\u6253\u5370\u592a\u591a\u65e0\u6548\u65e5\u5fd7\uff0c\u5bfc\u81f4\u65e5\u5fd7\u4fe1\u606f\u566a\u97f3\u8fc7\u591a\uff0c\u4ef7\u503c\u964d\u4f4e\u3002\u63a8\u8350\u4f7f\u7528 ",(0,s.jsx)(e.code,{children:"Info"})," \u65e5\u5fd7\u6253\u5370\u8bf7\u6c42\u5173\u952e\u4fe1\u606f\uff0c\u65b9\u4fbf\u6392\u67e5\u95ee\u9898"]}),"\n",(0,s.jsxs)(e.li,{children:["\u63a8\u8350\u65e5\u5fd7\u683c\u5f0f\u4e3a ",(0,s.jsx)(e.code,{children:"{[prefix]} {body ...}, {err: %v}"})," \u4e09\u6bb5\u5f0f","\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"prefix: \u7528\u5f53\u524d\u51fd\u6570\u540d"}),"\n",(0,s.jsx)(e.li,{children:"body: \u65e5\u5fd7\u4fe1\u606f\uff0c\u7528\u7a7a\u683c\u9694\u5f00\u5355\u8bcd\uff08\u5c3d\u91cf\u4f7f\u7528\u9a7c\u5cf0\uff09"}),"\n",(0,s.jsx)(e.li,{children:"err: \u5177\u4f53\u7684error\u4fe1\u606f"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'// good case\nfunc Test(ctx context.Context, uid int64) {\n     // do something ...\n     log.WithContext(ctx).Errorf("[Test] call ... err: %v, uid: %d", err, uid)\n     // do something ...\n}\n\n// bad case\nfunc Test(ctx context.Context, info *model.UserInfo) {\n     // do something ...\n     log.WithContext(ctx).Errorf("err: %v", err)\n     // do something ...\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u7ed3\u6784\u4f53\u6253\u5370",children:"\u7ed3\u6784\u4f53\u6253\u5370"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u65e5\u5fd7\u6253\u5370\u7ed3\u6784\u4f53\u5efa\u8bae ",(0,s.jsx)(e.code,{children:"json marshal"})," \u540e\u4f7f\u7528 ",(0,s.jsx)(e.code,{children:"%s"})," \u800c\u975e ",(0,s.jsx)(e.code,{children:"%v"})," \u6216 ",(0,s.jsx)(e.code,{children:"%+v"}),"\uff0c\u63a8\u8350\u4f7f\u7528 ",(0,s.jsx)(e.code,{children:"utils.Stringify"})]}),"\n",(0,s.jsxs)(e.li,{children:["\u5982\u679c\u7ed3\u6784\u4f53\u592a\u5927\u4e0d\u5efa\u8bae\u6253\u5370\uff0c\u65e5\u5fd7\u6253\u7ed3\u6784\u4f53\u614e\u7528\uff0c\u5982\u679c\u5927\u91cf\u7ed3\u6784\u4f53\u8fc7\u5927\u5bb9\u6613\u5f15\u53d1\u77ac\u95f4\u7684 ",(0,s.jsx)(e.code,{children:"OOM"})]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'// good case\nimport "github.com/go-eagle/eagle/pkg/utils"\n\nlog.WithContext(ctx).Errorf("... %s", utils.Stringify(x))\n\n// bad case\nlog.WithContext(ctx).Errorf("... %v", x)\nlog.WithContext(ctx).Errorf("... %+v", x)\n'})}),"\n",(0,s.jsx)(e.h2,{id:"\u9519\u8bef\u5904\u7406",children:"\u9519\u8bef\u5904\u7406"}),"\n",(0,s.jsx)(e.h3,{id:"error-\u8fd4\u56de",children:"error \u8fd4\u56de"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u8fd4\u56de error \u4f7f\u7528 ",(0,s.jsx)(e.code,{children:"fmt.Errof"})," %w wrap \u800c\u975e ",(0,s.jsx)(e.code,{children:"errors.New"}),"\uff0c\u5728\u4e0a\u5c42\u53ef\u4ee5\u4f7f\u7528 ",(0,s.jsx)(e.code,{children:"errors.Is"})," \u6216 ",(0,s.jsx)(e.code,{children:"errors.As"})," \u5224\u65ad\u7279\u5b9a\u9519\u8bef ",(0,s.jsx)(e.a,{href:"https://goplay.tools/snippet/LLUomMgFlAx",children:"https://goplay.tools/snippet/LLUomMgFlAx"})]}),"\n",(0,s.jsx)(e.li,{children:"\u8c03\u7528\u51fd\u6570\u8fd4\u56de error \u4f46\u662f\u53c8\u4e0d\u9700\u8981 return \u7684\u884c\u4e3a\uff0c\u5efa\u8bae\u6536\u655b\u5230\u51fd\u6570\u5185\u90e8\uff0c\u6216\u8005\u52a0\u4e0a\u6ce8\u91ca\u907f\u514d\u66f4\u597d\u7406\u89e3"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'// good case\n// error wrap\nfunc Test(ctx context.Context, uid int64) error {\n     // do something ...\n     if err := CallFunc(ctx, uid); err != nil {\n         return fmt.Errorf("[Test] call CallFunc err: %w, uid: %d", err, uid)\n     }\n     // do something ...\n     return nil\n}\n\n// \u8c03\u7528\u51fd\u6570\u8fd4\u56deerror\uff0c\u4e0d\u9700\u8981return\nfunc Test(ctx context.Context, uid int64) error {\n     // do something ...\n     if err := CallFunc(ctx, uid); err != nil {\n         // \u8fd9\u91cc\u9700\u8981\u52a0\u4e0a\u6ce8\u91ca\uff0c\u4e3a\u4ec0\u4e48\u4e0d\u9700\u8981return\uff0creviewer\u66f4\u597d\u7406\u89e3\n         log.Errorf("[Test] call CallFunc err: %v, uid: %d", err, uid)\n     }\n     // do something ...\n     return nil\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"error-\u5224\u65ad",children:"error \u5224\u65ad"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u901a\u8fc7 ",(0,s.jsx)(e.code,{children:"errors.Is"})," \u5224\u65ad error \u5224\u65ad\u662f\u5426\u662f\u5e95\u5c42\u7684\u67d0\u4e2a\u9519\u8bef\uff0c\u800c\u4e0d\u662f\u4f7f\u7528 ",(0,s.jsx)(e.code,{children:'err.Error() == "xxxx"'})," \u5b57\u7b26\u4e32\u7684\u65b9\u5f0f\u6765\u5224\u65ad"]}),"\n",(0,s.jsxs)(e.li,{children:["\u9700\u8981\u901a\u8fc7 ",(0,s.jsx)(e.code,{children:"fmt.Errorf"})," \u5bf9\u8fdb\u884c warp\uff0c\u624d\u53ef\u4ee5\u5224\u65ad\u662f\u5426\u4e3a\u5d4c\u5957 error"]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'// good case\ntype MyError struct {\n     Msg string\n}\n\nfunc (e *MyError) Error() string {\n     return e.Msg\n}\n\nfunc main() {\n     myErr := &MyError{Msg: "myErr"}\n     warpErr := fmt.Errorf("warp err:%w", myErr)\n     if errors.Is(warpErr, myErr) {\n         // do something ...\n     }\n}\n\n// bad case\ntype MyError struct {\n     Msg string\n}\n\nfunc (e *MyError) Error() string {\n     return e.Msg\n}\n\nfunc main() {\n     myErr := &MyError{Msg: "myErr"}\n     warpErr := fmt.Errorf("warp err:%w", myErr)\n     if warpErr.Error() == "xxx" {\n         // do something ...\n     }\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"panic-\u6392\u67e5",children:"panic \u6392\u67e5"}),"\n",(0,s.jsx)(e.p,{children:"\u9047\u5230\u4efb\u4f55 panic\uff0c\u90fd\u8bf7\u6309\u4ee5\u4e0b 4 \u6b65\u539f\u5219\u6765\u6392\u67e5"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"panic \u7684\u539f\u56e0"}),"\n",(0,s.jsx)(e.li,{children:"\u6808\u4ece\u54ea\u5f00\u59cb\u770b"}),"\n",(0,s.jsx)(e.li,{children:"\u62a5\u9519\u7684\u65b9\u6cd5\u662f\u4ec0\u4e48"}),"\n",(0,s.jsx)(e.li,{children:"\u62a5\u9519\u5177\u4f53\u4ee3\u7801\u4f4d\u7f6e\u5728\u54ea"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:"2024/10/31 15:14:44 http: panic serving [::1]:57144: runtime error: index out of range [1] with length 1 // 1. \u62a5\u9519\u7684\u539f\u56e0\ngoroutine 56 [running]:\nnet/http.(*conn).serve.func1()\n\t/usr/local/go/src/net/http/server.go:1903 +0xb0\npanic({0x103a7cd20?, 0x1400021e678?})\n\t/usr/local/go/src/runtime/panic.go:770 +0x124 // 2. \u6808\u7684\u5f00\u59cb\ndemo-http/internal/handler.Hello(0x14000226900) // 3. \u62a5\u9519\u7684\u65b9\u6cd5\n\t/Users/eagle/Codes/eagle-test/internal/handler/hello.go:28 +0x104 // 4. \u62a5\u9519\u5177\u4f53\u7684\u6587\u4ef6\u540d\u548c\u4ee3\u7801\u884c\u53f7\n"})}),"\n",(0,s.jsx)(e.h3,{id:"client-\u521d\u59cb\u5316\u62a5\u9519\u5904\u7406",children:"client \u521d\u59cb\u5316\u62a5\u9519\u5904\u7406"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"client \u521d\u59cb\u5316\u62a5 err\uff0c\u5e94\u8be5\u7acb\u523b panic\uff0c\u800c\u4e0d\u662f\u5ffd\u7565\u9519\u8bef\u7ee7\u7eed\u4e1a\u52a1\u903b\u8f91"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'package main\n\nimport (\n    "gorm.io/driver/mysql"\n    "gorm.io/gorm"\n)\n\nfunc initDB() *gorm.DB {\n    dsn := "user:password@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&parseTime=True&loc=Local"\n    db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{})\n    if err!= nil {\n        panic(err)\n    }\n    return db\n}\n\nfunc main() {\n    db := initDB()\n    // \u8fd9\u91cc\u53ef\u4ee5\u4f7f\u7528 db \u8fdb\u884c\u6570\u636e\u5e93\u64cd\u4f5c\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u5e38\u7528\u7ec4\u4ef6error\u5224\u65ad",children:"\u5e38\u7528\u7ec4\u4ef6error\u5224\u65ad"}),"\n",(0,s.jsx)(e.h4,{id:"mysql-gorm-\u7684-errrecordnotfound",children:"MySQL GORM \u7684 ErrRecordNotFound"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["Gorm v2\u4e2d\uff0c\u53ea\u6709 First()\u3001Last() \u3001Take() \u4e09\u4e2a\u65b9\u6cd5\u53ef\u80fd\u8fd4\u56de\u8fd9\u4e2a\u9519\u8bef",(0,s.jsx)(e.a,{href:"https://gorm.io/docs/query.html#Retrieving-a-single-object",children:"https://gorm.io/docs/query.html#Retrieving-a-single-object"})]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'func GetUser(name string) (*model.User, error)\n     res, err := db.Where("name = ?", name).Find(&users)\n     if err != nil && errors.Is(err, &gorm.ErrRecordNotFound) {\n          // do something ...   \n     }\n     return res, nil\n}\n'})}),"\n",(0,s.jsx)(e.h4,{id:"redis-redisnil-\u9519\u8bef",children:"Redis redis.Nil \u9519\u8bef"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'import "github.com/redis/go-redis/v9"\n\n// ...\nres, err := cmd.Result()\nif err != nil && errors.Is(err, redis.Nil) {\n     // do something ...    \n}\n// ...\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u6240\u6709\u534f\u7a0b\u90fd\u8981defer\u5904\u7406panic",children:"\u6240\u6709\u534f\u7a0b\u90fd\u8981defer\u5904\u7406panic"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u6846\u67b6\u53ea\u5bf9\u4e3b\u8fdb\u7a0b\u4e2d\u53d1\u751f\u7684 ",(0,s.jsx)(e.code,{children:"panic"})," \u515c\u5e95\uff0c\u5982\u679c\u662f\u4e1a\u52a1\u4e2d\u62c9\u53d6\u7684\u534f\u7a0b\uff0c\u90fd\u8981\u81ea\u884c\u5904\u7406 ",(0,s.jsx)(e.code,{children:"recover"}),"\uff0c\u5426\u5219\u53ef\u80fd\u56e0\u4e3a ",(0,s.jsx)(e.code,{children:"panic"})," \u65e0\u515c\u5e95\u6253\u6302\u6574\u4e2a\u670d\u52a1"]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:"// good case\nfunc main(){\n    go func(){\n        defer func(){\n            if err = recover(); err != nil{\n                // \u5904\u7406\u534f\u7a0b\u5185\u7684panic\n            }\n        }()\n        foo() // \u5f02\u6b65\u4e1a\u52a1\u903b\u8f91\n    }\n}\n\n// bad case\nfunc main(){\n    go foo() \n}\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u9ad8\u5e76\u53d1",children:"\u9ad8\u5e76\u53d1"}),"\n",(0,s.jsx)(e.h3,{id:"\u52a0\u9501\u907f\u514dio\u76f8\u5173\u64cd\u4f5c",children:"\u52a0\u9501\u907f\u514dio\u76f8\u5173\u64cd\u4f5c"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u52a0\u9501\u5185\u90e8\u4ee3\u7801\u5757\u4e0d\u5e94\u8be5IO\u64cd\u4f5c\uff0c\u4f1a\u6709\u6b7b\u9501\u98ce\u9669"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'// good case\ns.lock.Lock()\nif lastUpdateTime == 0 {\n        s.data = syncData\n        s.lastFullSyncTime = now\n} else {\n        s.incrSetCache(syncData, s.data)\n}\n\nif maxTime > s.lastUpdateTime {\n        s.lastUpdateTime = maxTime\n}\ns.lock.Unlock()\n\n// \u72ec\u7acb\u6253\u5370\u65e5\u5fd7\u51cf\u5c11\u5199\u9501\u8303\u56f4\nif lastUpdateTime == 0 {\n        log.Infof("full sync suc, syncData size=%d lastFullSyncTime=%v", count, now)\n} else {\n        log.Infof("incr sync suc, syncData size=%d originData size=%d count=%d lastUpdateTime=%v", len(syncData), len(s.data), count, lastUpdateTime)\n}\n\n// bad case\ns.lock.Lock()\ndefer s.lock.Unlock()\n\nif lastUpdateTime == 0 {\n\t// \u5199\u65e5\u5f0f\u6709io\u64cd\u4f5c \u6216\u8005 \u6bd4\u5982\u64cd\u4f5chttp\u3001redis\u3001db\u4e4b\u7c7b\u7684\n        log.Infof("full sync suc, syncData size=%d lastFullSyncTime=%v", count, now)\n} else {\n        log.Infof("incr sync suc, syncData size=%d originData size=%d count=%d lastUpdateTime=%v", len(syncData), len(s.data), count, lastUpdateTime)\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u9501\u7684\u6700\u4f73\u5b9e\u8df5",children:"\u9501\u7684\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u51cf\u5c11\u6301\u6709\u65f6\u95f4"}),"\n",(0,s.jsx)(e.li,{children:"\u4f18\u5316\u9501\u7684\u7c92\u5ea6"}),"\n",(0,s.jsx)(e.li,{children:"\u8bfb\u5199\u5206\u79bb"}),"\n",(0,s.jsx)(e.li,{children:"\u4f7f\u7528\u539f\u5b50\u64cd\u4f5c"}),"\n"]}),"\n",(0,s.jsx)(e.h4,{id:"\u51cf\u5c11\u6301\u6709\u65f6\u95f4",children:"\u51cf\u5c11\u6301\u6709\u65f6\u95f4"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u5c3d\u91cf\u51cf\u5c11\u9501\u7684\u6301\u6709\u65f6\u95f4\uff0c\u6bd5\u7adf\u4f7f\u7528\u9501\u662f\u6709\u4ee3\u4ef7\u7684\uff0c\u901a\u8fc7\u51cf\u5c11\u9501\u7684\u6301\u6709\u65f6\u95f4\u6765\u51cf\u8f7b\u8fd9\u4e2a\u4ee3\u4ef7"}),"\n",(0,s.jsx)(e.li,{children:"\u4e0d\u8981\u5728\u6301\u6709\u9501\u7684\u65f6\u5019\u505a IO \u64cd\u4f5c\uff0c\u5c3d\u91cf\u53ea\u901a\u8fc7\u6301\u6709\u9501\u6765\u4fdd\u62a4 IO \u64cd\u4f5c\u9700\u8981\u7684\u8d44\u6e90\u800c\u4e0d\u662f IO \u64cd\u4f5c\u672c\u8eab"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:"// good case\nfunc doSomething() {\n    ...\n    m.Lock()     // \u52a0\u9501\n    ...          // \u6570\u636e\u4fdd\u62a4\n    m.Unlock()   // \u91ca\u653e\u9501\n    // \u4ee5\u4e0b\u662f\u6709IO\u64cd\u4f5c\u7684\u4ee3\u7801\n    http.Get()\n}\n\n// bad case\nfunc doSomething() {\n    ...\n    m.Lock()    // \u52a0\u9501\n    ...\n    http.Get()  // \u5404\u79cd\u8017\u65f6\u7684 IO \u64cd\u4f5c\n    m.Unlock()  // \u91ca\u653e\u9501\n}\n"})}),"\n",(0,s.jsx)(e.h4,{id:"\u5584\u7528-defer",children:"\u5584\u7528 defer"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u5584\u7528 defer \u6765\u786e\u4fdd\u5728\u51fd\u6570\u5185\u6b63\u786e\u91ca\u653e\u4e86\u9501\uff0c\u901a\u8fc7 defer \u53ef\u4ee5\u786e\u4fdd\u4e0d\u4f1a\u9057\u6f0f\u91ca\u653e\u9501\u64cd\u4f5c\uff0c\u907f\u514d\u51fa\u73b0\u6b7b\u9501\u95ee\u9898\uff0c\u4ee5\u53ca\u907f\u514d\u51fd\u6570\u5185\u975e\u9884\u671f\u7684 panic \u5bfc\u81f4\u6b7b\u9501\u7684\u95ee\u9898\u3002"}),"\n",(0,s.jsxs)(e.li,{children:["\u4e0d\u8fc7\u4f7f\u7528 defer \u7684\u65f6\u5019\u4e5f\u8981\u6ce8\u610f ",(0,s.jsx)(e.code,{children:"defer m.Unlock()"})," \u53ef\u80fd\u4f1a\u5bfc\u81f4\u5728\u6301\u6709\u9501\u7684\u65f6\u5019\u505a\u4e86 IO \u64cd\u4f5c\uff0c\u51fa\u73b0\u4e86\u975e\u9884\u671f\u7684\u6301\u6709\u9501\u65f6\u95f4\u592a\u957f\u7684\u95ee\u9898\u3002"]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:"// good case\nfunc doSomething() error {\n    m.Lock()\n    defer m.Unlock()\n\n    err := ...\n    if err != nil {\n        return err\n    }\n\n    err = ...\n    if err != nil {\n        return err\n    }\n\n    ...\n    return nil\n}\n\n// bad case\n// \u975e\u9884\u671f\u7684\u5728\u6301\u6709\u9501\u671f\u95f4\u505a IO \u64cd\u4f5c\nfunc doSomething() {\n    m.Lock()\n    defer m.Unlock()\n    \n    item := ...\n    http.Get()   // \u5404\u79cd\u8017\u65f6\u7684 IO \u64cd\u4f5c\n}\n"})}),"\n",(0,s.jsx)(e.h4,{id:"\u4f18\u5316\u9501\u7684\u7c92\u5ea6",children:"\u4f18\u5316\u9501\u7684\u7c92\u5ea6"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u7ec6\u5316\u9501\u7684\u7c92\u5ea6\uff0c\u901a\u8fc7\u7ec6\u5316\u9501\u7684\u7c92\u5ea6\u6765\u51cf\u5c11\u9501\u7684\u6301\u6709\u65f6\u95f4\u4ee5\u53ca\u907f\u514d\u5728\u6301\u6709\u9501\u64cd\u4f5c\u7684\u65f6\u5019\u505a\u5404\u79cd\u8017\u65f6\u7684\u64cd\u4f5c\u3002"}),"\n",(0,s.jsx)(e.li,{children:"\u6700\u5e38\u7528\u7684\u65b9\u5f0f\u5c31\u662f\u4f7f\u7528\u5206\u6bb5\u9501\uff0c\u901a\u8fc7\u7a7a\u95f4\u6362\u65f6\u95f4\u6765\u4f18\u5316\u9501\u7684\u7c92\u5ea6\u63d0\u5347\u6027\u80fd\u3002"}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{src:"https://github.com/user-attachments/assets/365e74e6-68c0-4f60-8873-89773d56a108",alt:"\u5206\u6bb5\u9501"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:"// good case\n// \u901a\u8fc7\u5185\u90e8\u5c01\u88c5128\u4e2a\u9501\uff0c\u53ea\u8981\u5e76\u53d1\u4e0d\u8d85\u8fc7128\uff0c\u90fd\u4e0d\u4f1a\u5b58\u5728\u9501\u7684\u7ade\u4e89\ntype SafeRander struct {\n    pos     uint32\n    randers [128]*rand.Rand\n    locks   [128]*sync.Mutex\n}\n\nfunc (sr *SafeRander) Intn(n int) int {\n    x := atomic.AddUint32(&sr.pos, 1)\n    x %= 128\n    sr.locks[x].Lock()\n    n = sr.randers[x].Intn(n)\n    sr.locks[x].Unlock()\n    return n\n}\n\n// bad case\n// globalRand \u662f\u5168\u5c40\u6301\u6709\u4e00\u4e2a\u9501\uff0c\u8fd9\u6837\u5c31\u4f1a\u5bfc\u81f4\u6240\u6709\u6267\u884c rand \u51fd\u6570\u7684\u5730\u65b9\u4f1a\u53bb\u7ade\u4e89\u540c\u4e00\u4e2a\u9501\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u6027\u80fd\u964d\u4f4e\uff0c\u63d0\u5347\u6027\u80fd\u7684\u65b9\u5f0f\u662f\u53ef\u4ee5\u4f7f\u7528\u5206\u6bb5\u9501\u7684\u65b9\u5f0f\nvar globalRand = New(&lockedSource{\n    src: NewSource(1).(Source64),\n})\n\ntype lockedSource struct {\n    lk sync.Mutex\n    src Source64\n}\n"})}),"\n",(0,s.jsx)(e.h4,{id:"\u8bfb\u5199\u5206\u79bb",children:"\u8bfb\u5199\u5206\u79bb"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u5f53\u786e\u5b9a\u64cd\u4f5c\u4e0d\u4f1a\u4fee\u6539\u4fdd\u62a4\u7684\u8d44\u6e90\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528 RWMutex \u6765\u51cf\u5c11\u9501\u7b49\u5f85\u65f6\u95f4\uff0c\u4f7f\u7528\u8bfb\u5199\u9501\u6bd4\u5355\u7eaf\u4f7f\u7528\u666e\u901a\u9501\u7684\u6027\u80fd\u66f4\u597d\uff0c\u6548\u7387\u66f4\u9ad8"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:"// good case\n// \u8bfb\u64cd\u4f5c\u7528 RLock\nfunc GetName() string {\n    rw.RLock()\n    defer rw.RUnlock()\n\n    return name\n}\n\n// \u5199\u64cd\u4f5c\u7528 Lock\nfunc SetName(s string) string {\n    rw.Lock()\n    defer rw.Unlock()\n\n    name = s\n}\n"})}),"\n",(0,s.jsx)(e.h4,{id:"\u4f7f\u7528\u539f\u5b50\u64cd\u4f5c",children:"\u4f7f\u7528\u539f\u5b50\u64cd\u4f5c"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u76f8\u6bd4\u8bfb\u5199\u9501\uff0c\u4f7f\u7528\u539f\u5b50\u64cd\u4f5c\u5177\u6709\u66f4\u9ad8\u7684\u6027\u80fd\uff0c\u56e0\u4e3a\u539f\u5b50\u64cd\u4f5c\u4e0d\u4f1a\u89e6\u53d1 Go \u7684\u8c03\u5ea6\uff0c\u4e5f\u4e0d\u4f1a\u963b\u585e\u6267\u884c\u6d41\uff0c\u53ef\u4ee5\u4f7f\u7528 Golang \u7684 ",(0,s.jsx)(e.code,{children:"sync/atomic"})," \u5305\u4e2d\u7684\u63d0\u4f9b\u7684\u65b9\u6cd5"]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:"// good case\ntype AtomicCounter struct {\n    count int32\n}\n\nfunc (c *AtomicCounter) Count() {\n    atomic.AddInt32(&c.count, 1)\n}\n\nfunc (c *AtomicCounter) Read() {\n    _ = atomic.LoadInt32(&c.count)\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u7b80\u5355\u5e76\u53d1\u5e93",children:"\u7b80\u5355\u5e76\u53d1\u5e93"}),"\n",(0,s.jsx)(e.h4,{id:"\u5e76\u53d1\u9650\u5236",children:"\u5e76\u53d1\u9650\u5236"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u5e76\u53d1\u9650\u5236\u4f18\u5148\u4f7f\u7528\u6b64\u7ec4\u4ef6\u5e93 ",(0,s.jsx)(e.a,{href:"https://github.com/bytedance/gopkg/blob/main/util/gopool/pool.go",children:"gopool"})]}),"\n",(0,s.jsxs)(e.li,{children:["\u5982\u679c\u4e0d\u8003\u8651\u6027\u80fd\u4e5f\u53ef\u4ee5\u91c7\u7528\u5f00\u6e90\u5e93 ",(0,s.jsx)(e.a,{href:"https://remy.io/blog/sized-wait-group/",children:"SizedWaitGroup"})]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'// case 1\n// https://github.com/bytedance/gopkg/blob/main/util/gopool/pool_test.go\nfunc TestPool(t *testing.T) {\n     p := NewPool("test", 100, NewConfig())\n     var n int32\n     var wg sync.WaitGroup\n     for i := 0; i < 2000; i++ {\n         wg.Add(1)\n         p.Go(func() {\n             defer wg.Done()\n             atomic.AddInt32(&n, 1)\n         })\n     }\n     wg.Wait()\n     if n != 2000 {\n        t.Error(n)\n     }\n}\n\n// case 2\n// https://remy.io/blog/sized-wait-group/\nfunc main() {\n     rand.Seed(time.Now().UnixNano())\n\n     // Typical use-case:\n     // 50 queries must be executed as quick as possible\n     // but without overloading the database, so only\n     // 8 routines should be started concurrently.\n     swg := sizedwaitgroup.New(8)\n     for i := 0; i < 50; i++ {\n         swg.Add()\n         go func() {\n            defer swg.Done()\n            query()\n         }()\n     } \n     swg.Wait()\n}\n'})})]})}function h(n={}){const{wrapper:e}={...(0,l.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(a,{...n})}):a(n)}}}]);